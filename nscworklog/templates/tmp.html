{% extends "index.html" %}

{% block worklogs %}
<div class="worklog-info" data-worklog-id="{{ worklog._id }}">
    <dl>
        <!-- Display worklog details here -->
    </dl>
    <div class="button-container">
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
    </div>
</div>

<!-- Edit form will be inserted here dynamically -->
<div class="edit-form-container" style="display: none;"></div>
{% endblock %}

<script>
    $(document).ready(function () {
        let worklogId;
        // Attach click event listener to edit button
        $(".worklogs").on("click", function () {
            worklogId = $(".worklogs").data("worklog-id");
        });

        // Function to update worklog details dynamically
        function updateWorklogDetails(worklog) {
            const worklogInfo = $(".worklog-info");
            const list = worklogInfo.find("dl");
            list.empty();

            // Populate worklog details dynamically
            list.append(`<dt>Title</dt><dd>${worklog.title}</dd>`);
            list.append(`<dt>Description</dt><dd>${worklog.description}</dd>`);
            // Add other worklog properties dynamically
            $.each(worklog.extras, function (_, item) {
                for (const [key, value] of Object.entries(item)) {
                    list.append(`<dt>${key}</dt><dd>${value}</dd>`);
                }
            });
            worklogInfo.fadeIn();
        }

        // Attach click event listener to edit button
        $(".edit-btn").on("click", function () {
            // Make an Ajax request to get the worklog details
            $.ajax({
                url: `/worklogs/${worklogId}/edit`, // Replace with your actual edit endpoint
                method: "GET",
                success: function (editFormHtml) {
                    $(".edit-form-container").html(editFormHtml).slideDown();
                    $(".worklog-info").fadeOut();
                },
                error: function (error) {
                    console.error("Error fetching edit form:", error);
                }
            });
        });

        // Handle form submission asynchronously
        $(document).on("submit", "#edit-worklog-form", function (event) {
            event.preventDefault();

            const formData = $(this).serialize();
            const worklogId = $(".worklog-info").data("worklog-id");

            $.ajax({
                url: `/worklogs/${worklogId}`, // Replace with your actual update endpoint
                method: "POST",
                data: formData,
                success: function (updatedWorklog) {
                    // Handle success (e.g., update UI, hide edit form)
                    updateWorklogDetails(updatedWorklog);
                    $(".edit-form-container").slideUp();
                },
                error: function (error) {
                    console.error("Error updating worklog:", error);
                }
            });
        });
    });
</script>

<!-- Edit Form Template -->
<script id="edit-form-template" type="text/template">
  <form id="edit-worklog-form" method="POST">
    <!-- Add form fields dynamically based on your worklog structure -->
    <label for="title">Title</label>
    <input type="text" name="title" value="{{ worklog.title }}">
    
    <label for="description">Description</label>
    <textarea name="description">{{ worklog.description }}</textarea>

    <!-- Traverse the worklogs.extras list and repopulate the extras fields -->
    {% for extra in worklog.extras %}
      {% for key, value in extra.items() %}
        <label for="{{ key }}">{{ key }}</label>
        <input type="text" name="{{ key }}" value="{{ value }}">
      {% endfor %}
    {% endfor %}

    <button type="submit">Save</button>
  </form>
</script>